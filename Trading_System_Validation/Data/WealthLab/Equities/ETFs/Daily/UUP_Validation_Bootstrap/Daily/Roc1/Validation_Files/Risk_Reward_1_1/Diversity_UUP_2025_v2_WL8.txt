using WealthLab.Backtest;
using System;
using WealthLab.Core;
using WealthLab.Data;
using WealthLab.Indicators;
using System.Collections.Generic;
namespace WealthScript1
{
    public class Diversity_UUP_2025 : UserStrategyBase
    {
        // Max Risk % stop configuration (percent units)
        private double mLongStopPercent = 0.66362500;
        private double mShortStopPercent = 0.67373040;
        //constructor
        public Diversity_UUP_2025()
        {
            paramEnablePyramiding = AddParameter("Enable Pyramiding", ParameterType.Int32, 0, 0, 1, 1);
            paramMaxPyramids     = AddParameter("Max Pyramids (adds)", ParameterType.Int32, 3, 0, 10, 1);
            paramMaxHold        = AddParameter("Max Hold Period", ParameterType.Int32, 8, 5, 50, 5);
            paramSkipIfBothSides = AddParameter("Skip if Long & Short fire (flat)", ParameterType.Int32, 1, 0, 1, 1);
        }
        //create indicators and other objects here, this is executed prior to the main trading loop
        public override void Initialize(BarHistory bars)
        {
            // Start as early as possible; per-pattern guards will ensure safe access.
            StartIndex = 0;
        }
        //execute the strategy rules here, this is executed once for each bar in the backtest history
        public override void Execute(BarHistory bars, int idx)
        {
            //determine if we should check to go long or short
            bool allowPyramid = (paramEnablePyramiding.AsInt == 0) ? false : true;
            int maxAdds = paramMaxPyramids.AsInt;
            int allowedTotal = 1 + maxAdds; // initial + additional pyramids
            int openLong = 0, openShort = 0;
            foreach (Position p in OpenPositions)
            {
                if (!ReferenceEquals(p.Bars, bars)) continue; // per-symbol count only
                if (p.PositionType == PositionType.Long) openLong++;
                else if (p.PositionType == PositionType.Short) openShort++;
            }
            bool hasAny = (openLong + openShort) > 0;
            bool goLong = false, goShort = false;
            if (!allowPyramid)
            {
                goLong = !hasAny;
                goShort = !hasAny;
            }
            else
            {
                if (openLong > 0 && openShort == 0)
                {
                    goLong = openLong < allowedTotal;
                    goShort = false;
                }
                else if (openShort > 0 && openLong == 0)
                {
                    goShort = openShort < allowedTotal;
                    goLong = false;
                }
                else if (!hasAny)
                {
                    goLong = true;
                    goShort = true;
                }
                else
                {
                    goLong = false;
                    goShort = false;
                }
            }
            if (!hasAny && goLong && goShort && paramSkipIfBothSides.AsInt != 0)
            {
                bool longSignal = EnterLong(bars, idx);
                bool shortSignal = EnterShort(bars, idx);
                if (longSignal && shortSignal)
                    return; // stand aside this bar
                goLong = longSignal;
                goShort = shortSignal;
            }
            if (goLong)
            {
                if (EnterLong(bars, idx))
                {
                    Transaction t = PlaceTrade(bars, TransactionType.Buy, OrderType.Market, 0, patternNumber.ToString());
                    PosInfo pi = new PosInfo();
                    pi.StopLoss = stop;
                    pi.ProfitTarget = profit;
                    t.Tag = pi;
                    goShort = false; // enforce one-side-per-bar explicitly
                }
            }
            if (goShort)
            {
                if (EnterShort(bars, idx))
                {
                    Transaction t = PlaceTrade(bars, TransactionType.Short, OrderType.Market, 0, patternNumber.ToString());
                    PosInfo pi = new PosInfo();
                    pi.StopLoss = stop;
                    pi.ProfitTarget = profit;
                    t.Tag = pi;
                    goLong = false; // enforce one-side-per-bar explicitly
                }
            }
            //issue exits for existing positions
            foreach (Position position in OpenPositions)
            {
                if (idx - position.EntryBar >= paramMaxHold.AsInt)
                    ClosePosition(position, OrderType.Market, 0, "Max Hold");
                else
                {
                    PosInfo pi = (PosInfo)position.Tag;
                    ClosePosition(position, OrderType.Stop, position.EntryPrice * pi.StopLoss, "Stop");
                    ClosePosition(position, OrderType.Limit, position.EntryPrice * pi.ProfitTarget, "Profit");
                }
            }
        }
        // LONG patterns evaluated inline (no interpreter)
        public bool EnterLong(BarHistory bars, int idx)
        {
            // shorthand accessors scoped to this method
            double O(int n) => bars.Open[idx - n];
            double H(int n) => bars.High[idx - n];
            double L(int n) => bars.Low[idx - n];
            double C(int n) => bars.Close[idx - n];
            double V(int n) => bars.Volume[idx - n];
            // pattern 66 (requires 7 bars back)
            if (
                idx > 7 &&
                (
                (H(1) > L(1)) &&
                (L(1) > H(3)) &&
                (H(3) > H(4)) &&
                (H(4) > L(4)) &&
                (L(4) > L(3)) &&
                (L(3) > H(7)) &&
                (H(7) > L(7))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 66;
                return true;
            }
            // pattern 115 (requires 13 bars back)
            if (
                idx > 13 &&
                (
                (H(5) > H(6)) &&
                (H(6) > L(5)) &&
                (L(5) > L(6)) &&
                (L(6) > H(9)) &&
                (H(9) > L(9)) &&
                (L(9) > H(12)) &&
                (H(12) > H(13)) &&
                (H(13) > L(12)) &&
                (L(12) > L(13))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 115;
                return true;
            }
            // pattern 74 (requires 12 bars back)
            if (
                idx > 12 &&
                (
                (H(12) > L(12)) &&
                (L(12) > H(9)) &&
                (H(9) > L(9)) &&
                (L(9) > H(5)) &&
                (H(5) > L(5)) &&
                (L(5) > H(4)) &&
                (H(4) > L(4))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 74;
                return true;
            }
            // pattern 82 (requires 11 bars back)
            if (
                idx > 11 &&
                (
                (H(6) > H(5)) &&
                (H(5) > H(3)) &&
                (H(3) > L(6)) &&
                (L(6) > L(5)) &&
                (L(5) > L(3)) &&
                (L(3) > H(11)) &&
                (H(11) > L(11))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 82;
                return true;
            }
            // pattern 73 (requires 8 bars back)
            if (
                idx > 8 &&
                (
                (H(2) > L(2)) &&
                (L(2) > H(0)) &&
                (H(0) > L(0)) &&
                (L(0) > H(5)) &&
                (H(5) > L(5)) &&
                (L(5) > H(8)) &&
                (H(8) > L(8))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 73;
                return true;
            }
            // pattern 52 (requires 6 bars back)
            if (
                idx > 6 &&
                (
                (H(0) > L(0)) &&
                (L(0) > H(6)) &&
                (H(6) > H(3)) &&
                (H(3) > H(4)) &&
                (H(4) > L(6)) &&
                (L(6) > L(3)) &&
                (L(3) > L(4))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 52;
                return true;
            }
            // pattern 3 (requires 4 bars back)
            if (
                idx > 4 &&
                (
                (C(4) > O(4)) &&
                (O(4) > C(3)) &&
                (C(3) > O(3)) &&
                (O(3) > C(0)) &&
                (C(0) > O(0))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 3;
                return true;
            }
            // pattern 151 (requires 8 bars back)
            if (
                idx > 8 &&
                (
                (C(2) > L(3)) &&
                (L(3) > L(4)) &&
                (L(4) > L(6)) &&
                (L(6) > L(5)) &&
                (L(5) > L(8)) &&
                (L(8) > L(7))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 151;
                return true;
            }
            // pattern 28 (requires 12 bars back)
            if (
                idx > 12 &&
                (
                (H(12) > H(4)) &&
                (H(4) > H(5)) &&
                (H(5) > L(4)) &&
                (L(4) > L(12)) &&
                (L(12) > L(5))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 28;
                return true;
            }
            // pattern 109 (requires 13 bars back)
            if (
                idx > 13 &&
                (
                (H(5) > H(6)) &&
                (H(6) > L(5)) &&
                (L(5) > L(6)) &&
                (L(6) > H(10)) &&
                (H(10) > L(10)) &&
                (L(10) > H(12)) &&
                (H(12) > H(13)) &&
                (H(13) > L(12)) &&
                (L(12) > L(13))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 109;
                return true;
            }
            // pattern 76 (requires 10 bars back)
            if (
                idx > 10 &&
                (
                (H(3) > H(5)) &&
                (H(5) > L(3)) &&
                (L(3) > L(5)) &&
                (L(5) > H(6)) &&
                (H(6) > L(6)) &&
                (L(6) > H(10)) &&
                (H(10) > L(10))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 76;
                return true;
            }
            // pattern 108 (requires 7 bars back)
            if (
                idx > 7 &&
                (
                (C(0) > H(6)) &&
                (H(6) > H(5)) &&
                (H(5) > H(7)) &&
                (H(7) > L(6)) &&
                (L(6) > L(7)) &&
                (L(7) > L(5))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 108;
                return true;
            }
            // pattern 107 (requires 11 bars back)
            if (
                idx > 11 &&
                (
                (H(4) > H(5)) &&
                (H(5) > L(4)) &&
                (L(4) > L(5)) &&
                (L(5) > H(8)) &&
                (H(8) > L(8)) &&
                (L(8) > H(10)) &&
                (H(10) > H(11)) &&
                (H(11) > L(10)) &&
                (L(10) > L(11))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 107;
                return true;
            }
            // pattern 32 (requires 6 bars back)
            if (
                idx > 6 &&
                (
                (C(0) > O(0)) &&
                (O(0) > O(4)) &&
                (O(4) > C(4)) &&
                (C(4) > C(5)) &&
                (C(5) > O(5)) &&
                (O(5) > C(6)) &&
                (C(6) > O(6))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 32;
                return true;
            }
            // pattern 7 (requires 8 bars back)
            if (
                idx > 8 &&
                (
                (L(8) > L(6)) &&
                (L(6) > L(5)) &&
                (L(5) > L(7)) &&
                (L(7) > L(4))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 7;
                return true;
            }
            // pattern 23 (requires 6 bars back)
            if (
                idx > 6 &&
                (
                (C(1) > O(0)) &&
                (O(0) > O(1)) &&
                (O(1) > C(0)) &&
                (C(0) > C(6)) &&
                (C(6) > O(6))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 23;
                return true;
            }
            // pattern 76 (requires 7 bars back)
            if (
                idx > 7 &&
                (
                (H(0) > L(0)) &&
                (L(0) > H(2)) &&
                (H(2) > H(3)) &&
                (H(3) > L(3)) &&
                (L(3) > L(2)) &&
                (L(2) > H(7)) &&
                (H(7) > L(7))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 76;
                return true;
            }
            // pattern 64 (requires 12 bars back)
            if (
                idx > 12 &&
                (
                (H(5) > H(4)) &&
                (H(4) > L(4)) &&
                (L(4) > L(5)) &&
                (L(5) > H(10)) &&
                (H(10) > H(12)) &&
                (H(12) > L(10)) &&
                (L(10) > L(12))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 64;
                return true;
            }
            // pattern 127 (requires 9 bars back)
            if (
                idx > 9 &&
                (
                (C(3) > H(8)) &&
                (H(8) > H(7)) &&
                (H(7) > H(9)) &&
                (H(9) > H(6))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 127;
                return true;
            }
            // pattern 26 (requires 7 bars back)
            if (
                idx > 7 &&
                (
                (C(7) > O(7)) &&
                (O(7) > O(1)) &&
                (O(1) > O(0)) &&
                (O(0) > C(1)) &&
                (C(1) > C(0))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 26;
                return true;
            }
            // pattern 25 (requires 11 bars back)
            if (
                idx > 11 &&
                (
                (C(6) > O(6)) &&
                (O(6) > O(3)) &&
                (O(3) > C(3)) &&
                (C(3) > O(11)) &&
                (O(11) > C(11))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 25;
                return true;
            }
            // pattern 70 (requires 10 bars back)
            if (
                idx > 10 &&
                (
                (H(3) > H(5)) &&
                (H(5) > L(3)) &&
                (L(3) > L(5)) &&
                (L(5) > H(7)) &&
                (H(7) > H(10)) &&
                (H(10) > L(7)) &&
                (L(7) > L(10))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 70;
                return true;
            }
            // pattern 40 (requires 7 bars back)
            if (
                idx > 7 &&
                (
                (H(6) > H(7)) &&
                (H(7) > L(6)) &&
                (L(6) > L(7)) &&
                (L(7) > H(2)) &&
                (H(2) > H(3)) &&
                (H(3) > L(3)) &&
                (L(3) > L(2))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 40;
                return true;
            }
            // pattern 31 (requires 5 bars back)
            if (
                idx > 5 &&
                (
                (H(5) > C(4)) &&
                (C(4) > L(5)) &&
                (L(5) > C(1)) &&
                (C(1) > C(2)) &&
                (C(2) > C(3))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 31;
                return true;
            }
            // pattern 54 (requires 8 bars back)
            if (
                idx > 8 &&
                (
                (C(0) > O(0)) &&
                (O(0) > C(5)) &&
                (C(5) > O(5)) &&
                (O(5) > C(6)) &&
                (C(6) > O(6)) &&
                (O(6) > O(8)) &&
                (O(8) > C(8))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 54;
                return true;
            }
            // pattern 68 (requires 8 bars back)
            if (
                idx > 8 &&
                (
                (H(0) > L(0)) &&
                (L(0) > H(4)) &&
                (H(4) > H(5)) &&
                (H(5) > L(5)) &&
                (L(5) > L(4)) &&
                (L(4) > H(8)) &&
                (H(8) > L(8))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 68;
                return true;
            }
            // pattern 80 (requires 12 bars back)
            if (
                idx > 12 &&
                (
                (H(12) > L(12)) &&
                (L(12) > H(8)) &&
                (H(8) > L(8)) &&
                (L(8) > H(5)) &&
                (H(5) > L(5)) &&
                (L(5) > H(4)) &&
                (H(4) > L(4))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 80;
                return true;
            }
            // pattern 27 (requires 12 bars back)
            if (
                idx > 12 &&
                (
                (O(12) > C(12)) &&
                (C(12) > C(4)) &&
                (C(4) > O(4)) &&
                (O(4) > C(6)) &&
                (C(6) > O(6))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 27;
                return true;
            }
            // pattern 126 (requires 7 bars back)
            if (
                idx > 7 &&
                (
                (C(2) > H(6)) &&
                (H(6) > H(5)) &&
                (H(5) > H(7)) &&
                (H(7) > H(4))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 126;
                return true;
            }
            // pattern 13 (requires 11 bars back)
            if (
                idx > 11 &&
                (
                (C(3) > O(3)) &&
                (O(3) > O(11)) &&
                (O(11) > C(9)) &&
                (C(9) > C(11)) &&
                (C(11) > O(9))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 13;
                return true;
            }
            // pattern 84 (requires 2 bars back)
            if (
                idx > 2 &&
                (
                (C(1) > O(0)) &&
                (O(0) > O(2)) &&
                (O(2) > O(1)) &&
                (O(1) > C(0))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 84;
                return true;
            }
            // pattern 63 (requires 9 bars back)
            if (
                idx > 9 &&
                (
                (C(6) > C(5)) &&
                (C(5) > C(8)) &&
                (C(8) > C(9)) &&
                (C(9) > C(2)) &&
                (C(2) > C(1))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 63;
                return true;
            }
            // pattern 9 (requires 5 bars back)
            if (
                idx > 5 &&
                (
                (O(5) > C(5)) &&
                (C(5) > O(3)) &&
                (O(3) > C(1)) &&
                (C(1) > C(3)) &&
                (C(3) > O(1))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 9;
                return true;
            }
            // pattern 6 (requires 4 bars back)
            if (
                idx > 4 &&
                (
                (H(2) > H(0)) &&
                (H(0) > H(1)) &&
                (H(1) > H(3)) &&
                (H(3) > H(4))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 6;
                return true;
            }
            // pattern 7 (requires 8 bars back)
            if (
                idx > 8 &&
                (
                (O(0) > C(0)) &&
                (C(0) > O(8)) &&
                (O(8) > C(8)) &&
                (C(8) > C(7)) &&
                (C(7) > O(7))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 7;
                return true;
            }
            // pattern 43 (requires 8 bars back)
            if (
                idx > 8 &&
                (
                (C(0) > O(0)) &&
                (O(0) > O(4)) &&
                (O(4) > C(4)) &&
                (C(4) > C(7)) &&
                (C(7) > O(7)) &&
                (O(7) > C(8)) &&
                (C(8) > O(8))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 43;
                return true;
            }
            // pattern 66 (requires 7 bars back)
            if (
                idx > 7 &&
                (
                (H(7) > L(7)) &&
                (L(7) > H(4)) &&
                (H(4) > H(3)) &&
                (H(3) > H(1)) &&
                (H(1) > L(4)) &&
                (L(4) > L(3)) &&
                (L(3) > L(1))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 66;
                return true;
            }
            // pattern 131 (requires 12 bars back)
            if (
                idx > 12 &&
                (
                (C(5) > H(8)) &&
                (H(8) > H(9)) &&
                (H(9) > H(11)) &&
                (H(11) > H(10)) &&
                (H(10) > H(12))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 131;
                return true;
            }
            // pattern 74 (requires 13 bars back)
            if (
                idx > 13 &&
                (
                (H(5) > H(6)) &&
                (H(6) > L(5)) &&
                (L(5) > L(6)) &&
                (L(6) > H(10)) &&
                (H(10) > L(10)) &&
                (L(10) > H(13)) &&
                (H(13) > L(13))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 74;
                return true;
            }
            // pattern 38 (requires 11 bars back)
            if (
                idx > 11 &&
                (
                (C(7) > C(6)) &&
                (C(6) > C(4)) &&
                (C(4) > C(5)) &&
                (C(5) > C(11)) &&
                (C(11) > C(10))
                )
            )
            {
                stop = 1.0 - (0.66362500 / 100.0);
                profit = 1.0 + (0.59856200 / 100.0);
                patternNumber = 38;
                return true;
            }
            return false;
        }
        // SHORT patterns evaluated inline (no interpreter)
        public bool EnterShort(BarHistory bars, int idx)
        {
            // shorthand accessors scoped to this method
            double O(int n) => bars.Open[idx - n];
            double H(int n) => bars.High[idx - n];
            double L(int n) => bars.Low[idx - n];
            double C(int n) => bars.Close[idx - n];
            double V(int n) => bars.Volume[idx - n];
            // pattern 66 (requires 4 bars back)
            if (
                idx > 4 &&
                (
                (H(2) > C(2)) &&
                (C(2) > L(2)) &&
                (L(2) > H(3)) &&
                (H(3) > C(4)) &&
                (C(4) > C(3)) &&
                (C(3) > L(4)) &&
                (L(4) > L(3))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 66;
                return true;
            }
            // pattern 24 (requires 10 bars back)
            if (
                idx > 10 &&
                (
                (H(10) > H(3)) &&
                (H(3) > L(10)) &&
                (L(10) > H(5)) &&
                (H(5) > L(5)) &&
                (L(5) > L(3))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 24;
                return true;
            }
            // pattern 103 (requires 7 bars back)
            if (
                idx > 7 &&
                (
                (H(7) > C(0)) &&
                (C(0) > H(6)) &&
                (H(6) > L(6)) &&
                (L(6) > L(7))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 103;
                return true;
            }
            // pattern 73 (requires 5 bars back)
            if (
                idx > 5 &&
                (
                (H(3) > H(2)) &&
                (H(2) > H(4)) &&
                (H(4) > L(3)) &&
                (L(3) > L(4)) &&
                (L(4) > H(5)) &&
                (H(5) > L(5))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 73;
                return true;
            }
            // pattern 43 (requires 8 bars back)
            if (
                idx > 8 &&
                (
                (H(8) > L(8)) &&
                (L(8) > C(7)) &&
                (C(7) > H(5)) &&
                (H(5) > L(5)) &&
                (L(5) > C(6))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 43;
                return true;
            }
            // pattern 131 (requires 11 bars back)
            if (
                idx > 11 &&
                (
                (C(4) > H(7)) &&
                (H(7) > H(11)) &&
                (H(11) > H(8)) &&
                (H(8) > H(9)) &&
                (H(9) > H(10))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 131;
                return true;
            }
            // pattern 66 (requires 11 bars back)
            if (
                idx > 11 &&
                (
                (C(9) > C(11)) &&
                (C(11) > C(8)) &&
                (C(8) > C(5)) &&
                (C(5) > C(3)) &&
                (C(3) > C(4))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 66;
                return true;
            }
            // pattern 53 (requires 13 bars back)
            if (
                idx > 13 &&
                (
                (C(5) > C(6)) &&
                (C(6) > C(8)) &&
                (C(8) > C(7)) &&
                (C(7) > C(9)) &&
                (C(9) > C(10)) &&
                (C(10) > C(13))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 53;
                return true;
            }
            // pattern 9 (requires 5 bars back)
            if (
                idx > 5 &&
                (
                (L(2) > L(3)) &&
                (L(3) > L(1)) &&
                (L(1) > L(4)) &&
                (L(4) > L(0)) &&
                (L(0) > L(5))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 9;
                return true;
            }
            // pattern 51 (requires 2 bars back)
            if (
                idx > 2 &&
                (
                (H(1) > O(1)) &&
                (O(1) > H(2)) &&
                (H(2) > C(2)) &&
                (C(2) > O(2)) &&
                (O(2) > L(2)) &&
                (L(2) > L(1))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 51;
                return true;
            }
            // pattern 5 (requires 6 bars back)
            if (
                idx > 6 &&
                (
                (H(6) > H(0)) &&
                (H(0) > L(0)) &&
                (L(0) > L(6)) &&
                (L(6) > H(5)) &&
                (H(5) > L(5))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 5;
                return true;
            }
            // pattern 63 (requires 10 bars back)
            if (
                idx > 10 &&
                (
                (H(2) > H(4)) &&
                (H(4) > L(2)) &&
                (L(2) > L(4)) &&
                (L(4) > H(10)) &&
                (H(10) > L(10)) &&
                (L(10) > H(8)) &&
                (H(8) > L(8))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 63;
                return true;
            }
            // pattern 149 (requires 8 bars back)
            if (
                idx > 8 &&
                (
                (L(8) > L(7)) &&
                (L(7) > C(1)) &&
                (C(1) > L(6)) &&
                (L(6) > L(4)) &&
                (L(4) > L(5))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 149;
                return true;
            }
            // pattern 60 (requires 4 bars back)
            if (
                idx > 4 &&
                (
                (H(2) > C(2)) &&
                (C(2) > H(4)) &&
                (H(4) > H(3)) &&
                (H(3) > C(4)) &&
                (C(4) > C(3)) &&
                (C(3) > L(4)) &&
                (L(4) > L(3))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 60;
                return true;
            }
            // pattern 59 (requires 11 bars back)
            if (
                idx > 11 &&
                (
                (H(5) > H(6)) &&
                (H(6) > L(5)) &&
                (L(5) > L(6)) &&
                (L(6) > H(11)) &&
                (H(11) > L(11)) &&
                (L(11) > H(9)) &&
                (H(9) > L(9))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 59;
                return true;
            }
            // pattern 144 (requires 8 bars back)
            if (
                idx > 8 &&
                (
                (L(6) > L(5)) &&
                (L(5) > L(7)) &&
                (L(7) > L(8)) &&
                (L(8) > C(3))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 144;
                return true;
            }
            // pattern 31 (requires 9 bars back)
            if (
                idx > 9 &&
                (
                (H(9) > C(8)) &&
                (C(8) > C(7)) &&
                (C(7) > L(9)) &&
                (L(9) > C(6)) &&
                (C(6) > C(5))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 31;
                return true;
            }
            // pattern 30 (requires 8 bars back)
            if (
                idx > 8 &&
                (
                (H(8) > H(7)) &&
                (H(7) > L(8)) &&
                (L(8) > H(6)) &&
                (H(6) > L(7)) &&
                (L(7) > H(4)) &&
                (H(4) > L(6)) &&
                (L(6) > L(4))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 30;
                return true;
            }
            // pattern 35 (requires 7 bars back)
            if (
                idx > 7 &&
                (
                (C(3) > C(4)) &&
                (C(4) > C(5)) &&
                (C(5) > C(0)) &&
                (C(0) > C(6)) &&
                (C(6) > C(7))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 35;
                return true;
            }
            // pattern 83 (requires 2 bars back)
            if (
                idx > 2 &&
                (
                (C(2) > O(2)) &&
                (O(2) > C(0)) &&
                (C(0) > O(0)) &&
                (O(0) > C(1))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 83;
                return true;
            }
            // pattern 73 (requires 13 bars back)
            if (
                idx > 13 &&
                (
                (H(5) > L(5)) &&
                (L(5) > H(7)) &&
                (H(7) > L(7)) &&
                (L(7) > H(10)) &&
                (H(10) > H(13)) &&
                (H(13) > L(10)) &&
                (L(10) > L(13))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 73;
                return true;
            }
            // pattern 85 (requires 5 bars back)
            if (
                idx > 5 &&
                (
                (C(4) > O(3)) &&
                (O(3) > O(4)) &&
                (O(4) > C(3)) &&
                (C(3) > C(5))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 85;
                return true;
            }
            // pattern 94 (requires 10 bars back)
            if (
                idx > 10 &&
                (
                (H(5) > H(4)) &&
                (H(4) > L(5)) &&
                (L(5) > L(4)) &&
                (L(4) > H(8)) &&
                (H(8) > H(9)) &&
                (H(9) > L(8)) &&
                (L(8) > L(9)) &&
                (L(9) > H(10)) &&
                (H(10) > L(10))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 94;
                return true;
            }
            // pattern 19 (requires 8 bars back)
            if (
                idx > 8 &&
                (
                (C(8) > C(3)) &&
                (C(3) > C(5)) &&
                (C(5) > C(4)) &&
                (C(4) > C(6))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 19;
                return true;
            }
            // pattern 9 (requires 7 bars back)
            if (
                idx > 7 &&
                (
                (H(5) > L(5)) &&
                (L(5) > H(3)) &&
                (H(3) > H(7)) &&
                (H(7) > L(7)) &&
                (L(7) > L(3))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 9;
                return true;
            }
            // pattern 26 (requires 8 bars back)
            if (
                idx > 8 &&
                (
                (C(6) > C(7)) &&
                (C(7) > H(8)) &&
                (H(8) > C(5)) &&
                (C(5) > L(8))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 26;
                return true;
            }
            // pattern 38 (requires 7 bars back)
            if (
                idx > 7 &&
                (
                (C(6) > C(7)) &&
                (C(7) > C(3)) &&
                (C(3) > C(1)) &&
                (C(1) > C(2)) &&
                (C(2) > C(0))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 38;
                return true;
            }
            // pattern 9 (requires 4 bars back)
            if (
                idx > 4 &&
                (
                (H(4) > H(0)) &&
                (H(0) > L(0)) &&
                (L(0) > L(4)) &&
                (L(4) > H(2)) &&
                (H(2) > L(2))
                )
            )
            {
                stop = 1.0 + (0.67373040 / 100.0);
                profit = 1.0 - (0.58043920 / 100.0);
                patternNumber = 9;
                return true;
            }
            return false;
        }
        public override double GetMaxRiskStopLevel(BarHistory bars, PositionType pt, int idx)
        {
            double referencePrice = bars.Close[idx];
            double referenceStopPercent = (pt == PositionType.Long) ? mLongStopPercent : mShortStopPercent;
            double frac = referenceStopPercent / 100.0;
            double offset = referencePrice * frac;
            double stop = (pt == PositionType.Long) ? (referencePrice - offset) : (referencePrice + offset);
            return stop;
        }
        private Parameter paramEnablePyramiding;
        private Parameter paramMaxPyramids;
        private Parameter paramMaxHold;
        private Parameter paramSkipIfBothSides;
        private double stop;
        private double profit;
        private int patternNumber;
    }
    public class PosInfo
    {
        public double ProfitTarget { get; set; }
        public double StopLoss { get; set; }
    }
}
